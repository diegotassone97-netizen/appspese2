<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Gestione Spese Condivise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }

    .form-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-sizing: border-box;
    }

    .btn-primary {
      background-color: #4f46e5;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: background-color 0.3s;
    }

    .btn-primary:hover {
      background-color: #4338ca;
    }

    .card {
      background-color: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-delete {
      margin-top: 0.5rem;
      color: #ef4444;
      font-size: 0.875rem;
      cursor: pointer;
    }

    .btn-delete:hover {
      color: #b91c1c;
    }
  </style>
</head>

<body class="p-6 md:p-12">
  <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 z-50 hidden">
    <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
      </path>
    </svg>
  </div>

  <div class="max-w-4xl mx-auto space-y-8">
    <div class="card text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestione Spese Condivise</h1>
      <p class="text-gray-500">Traccia e bilancia le spese con facilità.</p>
    </div>

    <!-- Riepilogo saldi -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Riepilogo Saldi</h2>
      <div class="flex flex-col md:flex-row gap-4 justify-around text-center font-semibold">
        <div class="p-4 rounded-lg bg-red-100 flex-1">
          <p class="text-red-600 text-lg">Diego</p>
          <p id="saldo-diego" class="text-red-800 text-2xl mt-1">- €0.00</p>
        </div>
        <div class="p-4 rounded-lg bg-green-100 flex-1">
          <p class="text-green-600 text-lg">Lisa</p>
          <p id="saldo-lisa" class="text-green-800 text-2xl mt-1">- €0.00</p>
        </div>
      </div>
      <div class="mt-4 text-center">
        <p class="text-lg font-bold text-gray-700">Totale ancora da pagare:</p>
        <p id="total-due-all" class="text-3xl font-bold text-red-600 mt-1">€0.00</p>
      </div>
    </div>

    <!-- Aggiungi Spesa -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">Aggiungi Nuova Spesa</h2>
      <form id="expense-form" class="space-y-4">
        <div>
          <label for="expense-name" class="block text-gray-600 mb-1">Nome Spesa</label>
          <input type="text" id="expense-name" required class="form-input">
        </div>
        <div>
          <label for="expense-total" class="block text-gray-600 mb-1">Totale (€)</label>
          <input type="number" step="0.01" id="expense-total" required class="form-input">
        </div>
        <div>
          <label for="expense-notes" class="block text-gray-600 mb-1">Note (opzionali)</label>
          <textarea id="expense-notes" rows="3" class="form-input"></textarea>
        </div>
        <button type="submit" class="btn-primary w-full">Registra Spesa</button>
      </form>
    </div>

    <!-- Registra Pagamento -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">Registra Pagamento</h2>
      <form id="payment-form" class="space-y-4">
        <div>
          <label for="payment-date" class="block text-gray-600 mb-1">Data</label>
          <input type="date" id="payment-date" required class="form-input">
        </div>
        <div>
          <label for="payment-expense" class="block text-gray-600 mb-1">Spesa di riferimento</label>
          <select id="payment-expense" required class="form-input"></select>
        </div>
        <div>
          <label for="payment-payer" class="block text-gray-600 mb-1">Chi ha pagato</label>
          <select id="payment-payer" required class="form-input">
            <option value="Diego">Diego</option>
            <option value="Lisa">Lisa</option>
          </select>
        </div>
        <div>
          <label for="payment-amount" class="block text-gray-600 mb-1">Importo Pagato (€)</label>
          <input type="number" step="0.01" id="payment-amount" required class="form-input">
        </div>
        <button type="submit" class="btn-primary w-full">Registra Pagamento</button>
      </form>
    </div>

    <!-- Elenco Spese -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Elenco Spese</h2>
      <div id="expenses-list" class="space-y-4">
        <p id="no-expenses" class="text-gray-500 text-center">Nessuna spesa registrata.</p>
      </div>
    </div>

    <!-- Storico Pagamenti -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Storico Pagamenti</h2>
      <div id="payments-history-list" class="space-y-4">
        <p id="no-payments" class="text-gray-500 text-center">Nessun pagamento registrato.</p>
      </div>
    </div>

    <div id="message-container" class="fixed bottom-6 right-6 z-50 w-80"></div>
  </div>

  <!-- Script Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, doc, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAo40exxMQSGZcV8FgnF7XwrmDNDs-e1lY",
      authDomain: "appspese2.firebaseapp.com",
      projectId: "appspese2",
      storageBucket: "appspese2.appspot.com",
      messagingSenderId: "20924314267",
      appId: "1:20924314267:web:500dc7f170ce0b68e24c3e",
      measurementId: "G-J677Z3X6QY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const expensesCollection = collection(db, "spese");
    const paymentsCollection = collection(db, "pagamenti");

    const showLoading = () => document.getElementById('loading-spinner').classList.remove('hidden');
    const hideLoading = () => document.getElementById('loading-spinner').classList.add('hidden');
    const showMessage = (text, type = 'success') => {
      const container = document.getElementById('message-container');
      const messageDiv = document.createElement('div');
      messageDiv.className = `p-4 mb-4 rounded-lg shadow-lg text-white ${type==='success'?'bg-green-500':'bg-red-500'} transition-transform transform translate-x-full`;
      messageDiv.textContent = text;
      container.appendChild(messageDiv);
      setTimeout(()=>messageDiv.classList.remove('translate-x-full'),100);
      setTimeout(()=>{messageDiv.classList.add('translate-x-full');setTimeout(()=>messageDiv.remove(),500);},5000);
    };

    const expenseForm = document.getElementById('expense-form');
    const paymentForm = document.getElementById('payment-form');
    const expensesList = document.getElementById('expenses-list');
    const paymentsHistoryList = document.getElementById('payments-history-list');
    const paymentExpenseSelect = document.getElementById('payment-expense');
    const noExpensesMessage = document.getElementById('no-expenses');
    const noPaymentsMessage = document.getElementById('no-payments');

    let expensesData = [];
    let paymentsData = [];

    const calculateBalances = () => {
      let totalSpentDiego=0, totalSpentLisa=0, totalDueDiego=0, totalDueLisa=0, totalRemaining=0;
      expensesData.forEach(exp=>{
        const half = exp.totale/2;
        totalDueDiego+=half;
        totalDueLisa+=half;
        totalSpentDiego+=exp.pagatoDiego;
        totalSpentLisa+=exp.pagatoLisa;
        totalRemaining+=exp.residuo;
      });
      paymentsData.forEach(p=>{
        if(p.payer==='Diego') totalSpentDiego+=p.amount;
        else if(p.payer==='Lisa') totalSpentLisa+=p.amount;
      });
      document.getElementById('saldo-diego').textContent = `${totalSpentDiego-totalDueDiego>=0?'+':''} €${(totalSpentDiego-totalDueDiego).toFixed(2)}`;
      document.getElementById('saldo-lisa').textContent = `${totalSpentLisa-totalDueLisa>=0?'+':''} €${(totalSpentLisa-totalDueLisa).toFixed(2)}`;
      document.getElementById('total-due-all').textContent = `€${totalRemaining.toFixed(2)}`;
    };

    const updateExpensesList = () => {
      expensesList.innerHTML='';
      expensesData.forEach(exp=>{
        const el=document.createElement('div');
        el.className='p-6 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
        el.innerHTML=`
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-semibold text-gray-800">${exp.nome}</h3>
            <span class="text-lg font-bold text-gray-700">€${exp.totale.toFixed(2)}</span>
          </div>
          <p class="text-sm text-gray-500 mb-4">${exp.note||'Nessuna nota'}</p>
          <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
            <p>Pagato da Diego: <span class="font-medium text-green-700">€${exp.pagatoDiego.toFixed(2)}</span></p>
            <p>Pagato da Lisa: <span class="font-medium text-green-700">€${exp.pagatoLisa.toFixed(2)}</span></p>
            <p>Residuo: <span class="font-bold ${exp.residuo>0?'text-red-700':'text-green-700'}">€${exp.residuo.toFixed(2)}</span></p>
          </div>
          <button data-id="${exp.id}" class="btn-delete">🗑 Elimina Spesa</button>
        `;
        expensesList.appendChild(el);
        el.querySelector('button').addEventListener('click', async ()=>{
          try{
            await deleteDoc(doc(db,'spese',exp.id));
            paymentsData.filter(p=>p.expenseId===exp.id).forEach(async p=>await deleteDoc(doc(db,'pagamenti',p.id)));
            showMessage("Spesa eliminata!");
          }catch(err){console.error(err); showMessage("Errore eliminazione","error");}
        });
      });
    };

    const updatePaymentsHistory = () => {
      paymentsHistoryList.innerHTML='';
      paymentsData.forEach(p=>{
        const el=document.createElement('div');
        el.className='p-4 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
        el.innerHTML=`
          <p class="text-base text-gray-800 font-medium">${p.payer} ha pagato €${p.amount.toFixed(2)}</p>
          <p class="text-sm text-gray-600 mt-1">Spesa: ${p.expenseName}</p>
          <p class="text-xs text-gray-500 mt-1">Data: ${p.operazioneData.toDate().toLocaleDateString()}</p>
          <button data-id="${p.id}" class="btn-delete">🗑 Elimina Pagamento</button>
        `;
        paymentsHistoryList.appendChild(el);
        el.querySelector('button').addEventListener('click', async ()=>{
          try{
            await deleteDoc(doc(db,'pagamenti',p.id));
            const expense=expensesData.find(e=>e.id===p.expenseId);
            if(expense){
              const newDiego = p.payer==='Diego'?expense.pagatoDiego-p.amount:expense.pagatoDiego;
              const newLisa = p.payer==='Lisa'?expense.pagatoLisa-p.amount:expense.pagatoLisa;
              const residuo = expense.totale-(newDiego+newLisa);
              await updateDoc(doc(db,'spese',expense.id),{pagatoDiego:newDiego,pagatoLisa:newLisa,residuo});
            }
            showMessage("Pagamento eliminato!");
          }catch(err){console.error(err); showMessage("Errore eliminazione","error");}
        });
      });
    };

    const updatePaymentSelect = ()=>{
      paymentExpenseSelect.innerHTML='';
      expensesData.forEach(exp=>{
        const option=document.createElement('option');
        option.value=exp.id;
        option.textContent=`${exp.nome} (€${exp.totale.toFixed(2)})`;
        paymentExpenseSelect.appendChild(option);
      });
    };

    const updateUI = ()=>{
      updateExpensesList();
      updatePaymentsHistory();
      updatePaymentSelect();
      calculateBalances();
      noExpensesMessage.classList.toggle('hidden',expensesData.length>0);
      noPaymentsMessage.classList.toggle('hidden',paymentsData.length>0);
    };

    expenseForm.addEventListener('submit', async e=>{
      e.preventDefault();
      showLoading();
      const nome=document.getElementById('expense-name').value;
      const totale=parseFloat(document.getElementById('expense-total').value);
      const note=document.getElementById('expense-notes').value;
      try{
        await addDoc(expensesCollection,{
          nome,totale,note,pagatoDiego:0,pagatoLisa:0,residuo:totale,createdAt:Timestamp.now()
        });
        showMessage("Spesa registrata!");
        expenseForm.reset();
      }catch(err){console.error(err); showMessage("Errore","error");}
      finally{hideLoading();}
    });

    paymentForm.addEventListener('submit', async e=>{
      e.preventDefault();
      showLoading();
      const expenseId=document.getElementById('payment-expense').value;
      const payer=document.getElementById('payment-payer').value;
      const amount=parseFloat(document.getElementById('payment-amount').value);
      const date=document.getElementById('payment-date').value;
      if(!expenseId){showMessage("Seleziona spesa","error"); hideLoading(); return;}
      const expense=expensesData.find(e=>e.id===expenseId);
      if(!expense){showMessage("Spesa non trovata","error"); hideLoading(); return;}
      const newDiego=payer==='Diego'?expense.pagatoDiego+amount:expense.pagatoDiego;
      const newLisa=payer==='Lisa'?expense.pagatoLisa+amount:expense.pagatoLisa;
      const residuo=expense.totale-(newDiego+newLisa);
      try{
        await updateDoc(doc(db,'spese',expenseId),{pagatoDiego:newDiego,pagatoLisa:newLisa,residuo});
        await addDoc(paymentsCollection,{
          expenseId,expenseName:expense.nome,payer,amount,
          operazioneData:Timestamp.fromDate(new Date(date)),createdAt:Timestamp.now()
        });
        showMessage("Pagamento registrato!");
        paymentForm.reset();
      }catch(err){console.error(err); showMessage("Errore","error");}
      finally{hideLoading();}
    });

    onSnapshot(query(expensesCollection,orderBy("createdAt","desc")),snapshot=>{
      expensesData=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      updateUI();
    });

    onSnapshot(query(paymentsCollection,orderBy("operazioneData","desc")),snapshot=>{
      paymentsData=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      updateUI();
    });
  </script>
</body>

</html>





