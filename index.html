<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestione Spese Condivise</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color:#f3f4f6; }
    .form-input { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; box-sizing:border-box; }
    .btn-primary { background-color:#4f46e5; color:white; padding:12px 20px; border-radius:8px; font-weight:600; transition:background-color 0.3s; }
    .btn-primary:hover { background-color:#4338ca; }
    .btn-secondary { background-color:#e5e7eb; color:#4b5563; padding:8px 16px; border-radius:6px; font-weight:500; transition:background-color 0.3s; }
    .btn-secondary:hover { background-color:#d1d5db; }
    .btn-delete { cursor:pointer; color:#dc2626; font-size:0.875rem; font-weight:500; }
    .card { background:white; border-radius:12px; padding:24px; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="p-6 md:p-12">

  <!-- Spinner -->
  <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 z-50 hidden">
    <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 
      5.291A7.962 7.962 0 014 12H0c0 
      3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
  </div>

  <div class="max-w-4xl mx-auto space-y-8">
    <!-- Titolo -->
    <div class="card text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestione Spese Condivise</h1>
      <p class="text-gray-500">Traccia e bilancia le spese con facilità.</p>
    </div>

    <!-- Saldi -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Riepilogo Saldi</h2>
      <div class="flex flex-col md:flex-row gap-4 justify-around text-center font-semibold">
        <div class="p-4 rounded-lg bg-red-100 flex-1">
          <p class="text-red-600 text-lg">Diego</p>
          <p id="saldo-diego" class="text-red-800 text-2xl mt-1">- €0.00</p>
        </div>
        <div class="p-4 rounded-lg bg-green-100 flex-1">
          <p class="text-green-600 text-lg">Lisa</p>
          <p id="saldo-lisa" class="text-green-800 text-2xl mt-1">- €0.00</p>
        </div>
      </div>
      <div class="mt-4 text-center space-y-2">
        <p class="text-lg font-bold text-gray-700">Totale spese registrate:</p>
        <p id="total-expenses" class="text-2xl font-bold text-gray-700">€0.00</p>
        <p class="text-lg font-bold text-gray-700">Totale ancora da pagare:</p>
        <p id="total-due-all" class="text-3xl font-bold text-red-600 mt-1">€0.00</p>
      </div>
    </div>

    <!-- Aggiungi spesa -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">Aggiungi Nuova Spesa</h2>
      <form id="expense-form" class="space-y-4">
        <div>
          <label for="expense-name" class="block text-gray-600 mb-1">Nome Spesa</label>
          <input type="text" id="expense-name" required class="form-input">
        </div>
        <div>
          <label for="expense-total" class="block text-gray-600 mb-1">Totale (€)</label>
          <input type="number" step="0.01" id="expense-total" required class="form-input">
        </div>
        <div>
          <label for="expense-notes" class="block text-gray-600 mb-1">Note (opzionali)</label>
          <textarea id="expense-notes" rows="3" class="form-input"></textarea>
        </div>
        <button type="submit" class="btn-primary w-full">Registra Spesa</button>
      </form>
    </div>

    <!-- Aggiungi pagamento -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">Registra Pagamento</h2>
      <form id="payment-form" class="space-y-4">
        <div>
          <label for="payment-date" class="block text-gray-600 mb-1">Data</label>
          <input type="date" id="payment-date" required class="form-input">
        </div>
        <div>
          <label for="payment-expense" class="block text-gray-600 mb-1">Spesa di riferimento</label>
          <select id="payment-expense" required class="form-input"></select>
        </div>
        <div>
          <label for="payment-payer" class="block text-gray-600 mb-1">Chi ha pagato</label>
          <select id="payment-payer" required class="form-input">
            <option value="Diego">Diego</option>
            <option value="Lisa">Lisa</option>
          </select>
        </div>
        <div>
          <label for="payment-amount" class="block text-gray-600 mb-1">Importo Pagato (€)</label>
          <input type="number" step="0.01" id="payment-amount" required class="form-input">
        </div>
        <button type="submit" class="btn-primary w-full">Registra Pagamento</button>
      </form>
    </div>

    <!-- Elenco Spese -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Elenco Spese</h2>
      <div id="expenses-list" class="space-y-4">
        <p id="no-expenses" class="text-gray-500 text-center">Nessuna spesa registrata.</p>
      </div>
    </div>

    <!-- Storico Pagamenti -->
    <div class="card">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Storico Pagamenti</h2>
      <div id="payments-history-list" class="space-y-4">
        <p id="no-payments" class="text-gray-500 text-center">Nessun pagamento registrato.</p>
      </div>
    </div>

    <div id="message-container" class="fixed bottom-6 right-6 z-50 w-80"></div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAo40exxMQSGZcV8FgnF7XwrmDNDs-e1lY",
      authDomain: "appspese2.firebaseapp.com",
      projectId: "appspese2",
      storageBucket: "appspese2.appspot.com",
      messagingSenderId: "20924314267",
      appId: "1:20924314267:web:500dc7f170ce0b68e24c3e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const expensesCollection = collection(db,"spese");
    const paymentsCollection = collection(db,"pagamenti");

    const showLoading = ()=>document.getElementById('loading-spinner').classList.remove('hidden');
    const hideLoading = ()=>document.getElementById('loading-spinner').classList.add('hidden');
    const showMessage=(text,type='success')=>{
      const c=document.getElementById('message-container');
      const d=document.createElement('div');
      d.className=`p-4 mb-4 rounded-lg shadow-lg text-white ${type==='success'?'bg-green-500':'bg-red-500'} transition-transform transform translate-x-full`;
      d.textContent=text; c.appendChild(d);
      setTimeout(()=>d.classList.remove('translate-x-full'),100);
      setTimeout(()=>{d.classList.add('translate-x-full');setTimeout(()=>d.remove(),500)},5000);
    };

    const expenseForm=document.getElementById('expense-form');
    const paymentForm=document.getElementById('payment-form');
    const expensesList=document.getElementById('expenses-list');
    const paymentsHistoryList=document.getElementById('payments-history-list');
    const paymentExpenseSelect=document.getElementById('payment-expense');
    const noExpensesMessage=document.getElementById('no-expenses');
    const noPaymentsMessage=document.getElementById('no-payments');

    let expensesData=[], paymentsData=[];

    // Calcola i saldi
    const calculateBalances=()=>{
      let totalDueDiego=0,totalDueLisa=0,totalPaidDiego=0,totalPaidLisa=0,totalRemaining=0,totalExpenses=0;
      expensesData.forEach(exp=>{
        const half=exp.totale/2;
        totalDueDiego+=half; totalDueLisa+=half; totalExpenses+=exp.totale;
        const paidForExpense=paymentsData.filter(p=>p.expenseId===exp.id).reduce((s,p)=>s+p.amount,0);
        const residuo=exp.totale-paidForExpense;
        totalRemaining+=residuo;
      });
      paymentsData.forEach(p=>{
        if(p.payer==='Diego') totalPaidDiego+=p.amount;
        else if(p.payer==='Lisa') totalPaidLisa+=p.amount;
      });
      const saldoDiego=totalPaidDiego-totalDueDiego;
      const saldoLisa=totalPaidLisa-totalDueLisa;
      document.getElementById('saldo-diego').textContent=`${saldoDiego>=0?'+':''} €${saldoDiego.toFixed(2)}`;
      document.getElementById('saldo-lisa').textContent=`${saldoLisa>=0?'+':''} €${saldoLisa.toFixed(2)}`;
      document.getElementById('total-due-all').textContent=`€${totalRemaining.toFixed(2)}`;
      document.getElementById('total-expenses').textContent=`€${totalExpenses.toFixed(2)}`;
    };

    // Aggiorna interfaccia
    const updateUI=()=>{
      // spese
      expensesList.innerHTML='';
      expensesData.forEach(exp=>{
        const paid=paymentsData.filter(p=>p.expenseId===exp.id).reduce((s,p)=>s+p.amount,0);
        const residuo=exp.totale-paid;
        const div=document.createElement('div');
        div.className='p-6 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
        div.innerHTML=`
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-semibold text-gray-800">${exp.nome}</h3>
            <span class="text-lg font-bold text-gray-700">€${exp.totale.toFixed(2)}</span>
          </div>
          <p class="text-sm text-gray-500 mb-2">${exp.note||'Nessuna nota'}</p>
          <p class="text-sm font-medium ${residuo>0?'text-red-600':'text-green-600'}">Residuo: €${residuo.toFixed(2)}</p>
          <span class="btn-delete" data-id="${exp.id}" data-type="expense">Elimina</span>
        `;
        expensesList.appendChild(div);
      });
      // menu pagamenti
      paymentExpenseSelect.innerHTML='';
      expensesData.forEach(exp=>{
        const opt=document.createElement('option');
        opt.value=exp.id; opt.textContent=`${exp.nome} (€${exp.totale.toFixed(2)})`;
        paymentExpenseSelect.appendChild(opt);
      });
      noExpensesMessage.classList.toggle('hidden',expensesData.length>0);

      // pagamenti
      paymentsHistoryList.innerHTML='';
      paymentsData.forEach(p=>{
        const div=document.createElement('div');
        div.className='p-4 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
        div.innerHTML=`
          <p class="text-base text-gray-800 font-medium">${p.payer} ha pagato €${p.amount.toFixed(2)}</p>
          <p class="text-sm text-gray-600 mt-1">Spesa: ${p.expenseName}</p>
          <p class="text-xs text-gray-500 mt-1">Data: ${new Date(p.operazioneData).toLocaleDateString()}</p>
          <span class="btn-delete" data-id="${p.id}" data-type="payment">Elimina</span>
        `;
        paymentsHistoryList.appendChild(div);
      });
      noPaymentsMessage.classList.toggle('hidden',paymentsData.length>0);

      calculateBalances();
    };

    // Aggiungi Spesa
    expenseForm.addEventListener('submit',async e=>{
      e.preventDefault(); showLoading();
      const nome=document.getElementById('expense-name').value;
      const totale=parseFloat(document.getElementById('expense-total').value);
      const note=document.getElementById('expense-notes').value;
      try{
        await addDoc(expensesCollection,{nome,totale,note,createdAt:Date.now()});
        showMessage("Spesa registrata!"); expenseForm.reset();
      }catch(err){console.error(err);showMessage("Errore spesa",'error');}
      finally{hideLoading();}
    });

    // Aggiungi Pagamento
    paymentForm.addEventListener('submit',async e=>{
      e.preventDefault(); showLoading();
      const expenseId=document.getElementById('payment-expense').value;
      const payer=document.getElementById('payment-payer').value;
      const amount=parseFloat(document.getElementById('payment-amount').value);
      const operazioneData=new Date(document.getElementById('payment-date').value).getTime();
      const expense=expensesData.find(exp=>exp.id===expenseId);
      if(!expense){showMessage("Spesa non trovata",'error'); hideLoading(); return;}
      const paidSoFar=paymentsData.filter(p=>p.expenseId===expenseId).reduce((s,p)=>s+p.amount,0);
      const residuo=expense.totale-paidSoFar;
      if(amount>residuo){showMessage("Importo superiore al residuo!","error"); hideLoading(); return;}
      try{
        await addDoc(paymentsCollection,{expenseId,expenseName:expense.nome,payer,amount,operazioneData,createdAt:Date.now()});
        showMessage("Pagamento registrato!"); paymentForm.reset();
      }catch(err){console.error(err);showMessage("Errore pagamento",'error');}
      finally{hideLoading();}
    });

    // Elimina
    document.body.addEventListener('click',async e=>{
      if(e.target.classList.contains('btn-delete')){
        if(!confirm("Confermi l'eliminazione?")) return;
        const id=e.target.dataset.id; const type=e.target.dataset.type;
        showLoading();
        try{
          if(type==='expense'){
            await deleteDoc(doc(db,'spese',id));
            const related=paymentsData.filter(p=>p.expenseId===id);
            for(const p of related){ await deleteDoc(doc(db,'pagamenti',p.id)); }
          } else if(type==='payment'){ await deleteDoc(doc(db,'pagamenti',id)); }
          showMessage("Eliminazione completata!");
        }catch(err){console.error(err);showMessage("Errore eliminando",'error');}
        finally{hideLoading();}
      }
    });

    // Listener Firestore
    onSnapshot(query(expensesCollection,orderBy('createdAt','desc')),snap=>{
      expensesData=snap.docs.map(doc=>({id:doc.id,...doc.data()})); updateUI();
    });
    onSnapshot(query(paymentsCollection,orderBy('operazioneData','desc')),snap=>{
      paymentsData=snap.docs.map(doc=>({id:doc.id,...doc.data()})); updateUI();
    });
  </script>
</body>
</html>





