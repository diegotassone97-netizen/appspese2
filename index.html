<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Spese Condivise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .container {
            max-width: 900px;
        }

        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
            transform: translateY(-2px);
        }

        input,
        select,
        button {
            transition: all 0.2s ease-in-out;
        }

        .input-field {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
        }

        #balance-list li {
            padding: 0.5rem 0;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards;
            display: none;
        }

        .toast.success {
            background-color: #10b981;
        }

        .toast.error {
            background-color: #ef4444;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-100 p-6">
    <div id="toast-message" class="toast"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">Gestione Spese Condivise</h1>
            <p class="text-lg text-gray-500">
                La tua app per dividere i conti con amici e coinquilini.
            </p>
            <div class="mt-4 text-sm text-gray-500">
                ID Utente: <span id="user-id" class="font-mono text-gray-700">Caricamento...</span>
            </div>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Colonna per i formulari e i saldi -->
            <div class="flex flex-col gap-8">
                <!-- Sezione Saldi -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Saldi Correnti</h2>
                    <ul id="balance-list" class="text-lg">
                        <!-- I saldi verranno inseriti qui dal JS -->
                    </ul>
                </section>

                <!-- Sezione Aggiungi Spesa -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Aggiungi Nuova Spesa</h2>
                    <form id="add-expense-form" class="flex flex-col gap-4">
                        <input type="text" id="expense-description" placeholder="Descrizione" required
                            class="input-field">
                        <input type="number" id="expense-amount" placeholder="Importo (€)" min="0.01" step="0.01"
                            required class="input-field">
                        <select id="expense-paid-by" required class="input-field">
                            <option value="">Chi ha pagato?</option>
                        </select>
                        <select id="expense-paid-for" multiple required class="input-field h-32">
                            <!-- Le opzioni verranno popolate dal JS -->
                        </select>
                        <button type="submit" class="btn btn-primary w-full">Aggiungi Spesa</button>
                    </form>
                </section>

                <!-- Sezione Registra Pagamento -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Registra Pagamento</h2>
                    <form id="record-payment-form" class="flex flex-col gap-4">
                        <select id="payment-from" required class="input-field">
                            <option value="">Pagante</option>
                        </select>
                        <select id="payment-to" required class="input-field">
                            <option value="">Destinatario</option>
                        </select>
                        <input type="number" id="payment-amount" placeholder="Importo (€)" min="0.01" step="0.01"
                            required class="input-field">
                        <input type="date" id="payment-date" required class="input-field">
                        <button type="submit" class="btn btn-primary w-full">Registra Pagamento</button>
                    </form>
                </section>
            </div>

            <!-- Colonna per le liste di spese e pagamenti -->
            <div class="flex flex-col gap-8">
                <!-- Sezione Lista Spese -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista Spese</h2>
                    <div id="expenses-list" class="divide-y divide-gray-200">
                        <!-- Le spese verranno inserite qui dal JS -->
                        <p class="text-gray-500 text-center py-4">Nessuna spesa registrata.</p>
                    </div>
                </section>

                <!-- Sezione Storico Pagamenti -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Storico Pagamenti</h2>
                    <div id="payments-history" class="divide-y divide-gray-200">
                        <!-- Lo storico dei pagamenti verrà inserito qui dal JS -->
                        <p class="text-gray-500 text-center py-4">Nessun pagamento registrato.</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modale per la conferma di eliminazione -->
    <div id="delete-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Conferma Eliminazione</h3>
            <p class="text-gray-600 mb-6">Sei sicuro di voler eliminare questa spesa?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete" class="btn btn-secondary">Annulla</button>
                <button id="confirm-delete" class="btn bg-red-500 text-white hover:bg-red-600">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK e script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, runTransaction,
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // La tua configurazione di Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAo40exxMQSGZcV8FgnF7XwrmDNDs-e1lY",
            authDomain: "appspese2.firebaseapp.com",
            projectId: "appspese2",
            storageBucket: "appspese2.firebasestorage.app",
            messagingSenderId: "20924314267",
            appId: "1:20924314267:web:500dc7f170ce0b68e24c3e",
            measurementId: "G-J677Z3X6QY"
        };
        const appId = "1:20924314267:web:500dc7f170ce0b68e24c3e";

        // Variabili globali per Firebase
        let db;
        let auth;
        let userId = 'anonimo';
        let expensesCollection;
        let paymentsCollection;
        let usersCollection;

        // Funzione per mostrare un messaggio temporaneo
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.className = 'toast ' + (isError ? 'error' : 'success');
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Funzione di inizializzazione di Firebase
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase initialized.");

                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        console.log("User authenticated:", userId);

                        // Imposta le collezioni per l'utente autenticato
                        const publicDataPath = `artifacts/${appId}/public/data`;
                        expensesCollection = collection(db, publicDataPath, 'expenses');
                        paymentsCollection = collection(db, publicDataPath, 'payments');
                        usersCollection = collection(db, publicDataPath, 'users');

                        // Registra i listener solo dopo l'autenticazione
                        registerEventListeners();
                        setupRealtimeListeners();

                        await ensureCurrentUserDocExists();

                    } else {
                        console.error("Authentication failed. The app will not be able to connect to the database.");
                        document.getElementById('user-id').textContent = 'Autenticazione Fallita!';
                        // Disabilita i form se l'autenticazione fallisce
                        document.getElementById('add-expense-form').style.pointerEvents = 'none';
                        document.getElementById('add-expense-form').style.opacity = '0.5';
                        document.getElementById('record-payment-form').style.pointerEvents = 'none';
                        document.getElementById('record-payment-form').style.opacity = '0.5';
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('user-id').textContent = 'Errore di configurazione. Controlla la console.';
            }
        }

        async function ensureCurrentUserDocExists() {
            try {
                await setDoc(doc(usersCollection, userId), {
                    displayName: `Utente ${userId.substring(0, 4)}`,
                    createdAt: new Date().toISOString()
                }, { merge: true });
            } catch (error) {
                console.error("Error ensuring user document exists:", error);
            }
        }

        // Funzione per aggiornare l'elenco degli utenti
        function updateUsersList(usersDocs) {
            const users = usersDocs.map(doc => ({ id: doc.id, ...doc.data() }));
            const selectPaidBy = document.getElementById('expense-paid-by');
            const selectPaidFor = document.getElementById('expense-paid-for');
            const selectPaymentFrom = document.getElementById('payment-from');
            const selectPaymentTo = document.getElementById('payment-to');

            [selectPaidBy, selectPaidFor, selectPaymentFrom, selectPaymentTo].forEach(select => {
                select.innerHTML = '';
            });

            const defaultPaidByOption = document.createElement('option');
            defaultPaidByOption.value = '';
            defaultPaidByOption.textContent = 'Chi ha pagato?';
            defaultPaidByOption.disabled = true;
            defaultPaidByOption.selected = true;
            selectPaidBy.appendChild(defaultPaidByOption);

            const defaultFromOption = document.createElement('option');
            defaultFromOption.value = '';
            defaultFromOption.textContent = 'Pagante';
            defaultFromOption.disabled = true;
            defaultFromOption.selected = true;
            selectPaymentFrom.appendChild(defaultFromOption);

            const defaultToOption = document.createElement('option');
            defaultToOption.value = '';
            defaultToOption.textContent = 'Destinatario';
            defaultToOption.disabled = true;
            defaultToOption.selected = true;
            selectPaymentTo.appendChild(defaultToOption);

            users.forEach(user => {
                const optionPaidBy = document.createElement('option');
                optionPaidBy.value = user.id;
                optionPaidBy.textContent = user.id;
                selectPaidBy.appendChild(optionPaidBy);

                const optionPaidFor = document.createElement('option');
                optionPaidFor.value = user.id;
                optionPaidFor.textContent = user.id;
                selectPaidFor.appendChild(optionPaidFor);

                const optionPaymentFrom = document.createElement('option');
                optionPaymentFrom.value = user.id;
                optionPaymentFrom.textContent = user.id;
                selectPaymentFrom.appendChild(optionPaymentFrom);

                const optionPaymentTo = document.createElement('option');
                optionPaymentTo.value = user.id;
                optionPaymentTo.textContent = user.id;
                selectPaymentTo.appendChild(optionPaymentTo);
            });
        }

        // Listener per i dati in tempo reale
        function setupRealtimeListeners() {
            // Listener per la collezione 'users'
            onSnapshot(usersCollection, (snapshot) => {
                const usersDocs = snapshot.docs;
                updateUsersList(usersDocs);
                console.log("Users data updated:", usersDocs.length, "users found.");
            }, (error) => {
                console.error("Error fetching users:", error);
            });

            // Listener per la collezione 'expenses'
            onSnapshot(expensesCollection, (snapshot) => {
                const expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateExpensesList(expenses);
                console.log("Expenses data updated:", expenses.length, "expenses found.");
            }, (error) => {
                console.error("Error fetching expenses:", error);
            });

            // Listener per la collezione 'payments'
            onSnapshot(paymentsCollection, (snapshot) => {
                const payments = snapshot.docs.map(doc => doc.data());
                updatePaymentsHistory(payments);
                updateBalances();
                console.log("Payments data updated:", payments.length, "payments found.");
            }, (error) => {
                console.error("Error fetching payments:", error);
            });
        }

        // Funzione per aggiornare l'elenco delle spese
        function updateExpensesList(expenses) {
            const list = document.getElementById('expenses-list');
            list.innerHTML = '';
            if (expenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata.</p>';
            } else {
                expenses.forEach(expense => {
                    const div = document.createElement('div');
                    div.className = 'expense-item';
                    const paidForNames = expense.paidFor.join(', ');
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${expense.description}</p>
                            <p class="text-sm text-gray-600">
                                Pagato da ${expense.paidBy} per ${paidForNames}
                            </p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-bold text-gray-700">${(expense.amount || 0).toFixed(2)}€</span>
                            <button data-id="${expense.id}" class="delete-expense text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }

        // Funzione per aggiornare lo storico dei pagamenti
        function updatePaymentsHistory(payments) {
            const list = document.getElementById('payments-history');
            list.innerHTML = '';
            if (payments.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessun pagamento registrato.</p>';
            } else {
                payments.sort((a, b) => new Date(b.date) - new Date(a.date));
                payments.forEach(payment => {
                    const div = document.createElement('div');
                    div.className = 'expense-item';
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">Pagamento</p>
                            <p class="text-sm text-gray-600">
                                Da ${payment.from} a ${payment.to} - ${new Date(payment.date).toLocaleDateString()}
                            </p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-bold text-gray-700">${(payment.amount || 0).toFixed(2)}€</span>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }

        // Funzione per calcolare e aggiornare i saldi
        async function updateBalances() {
            const expensesSnapshot = await new Promise(resolve => onSnapshot(expensesCollection, resolve));
            const paymentsSnapshot = await new Promise(resolve => onSnapshot(paymentsCollection, resolve));
            const usersSnapshot = await new Promise(resolve => onSnapshot(usersCollection, resolve));

            const users = usersSnapshot.docs.map(doc => doc.id);
            const expenses = expensesSnapshot.docs.map(doc => doc.data());
            const payments = paymentsSnapshot.docs.map(doc => doc.data());

            let balances = {};
            users.forEach(user => balances[user] = 0);

            expenses.forEach(expense => {
                const amount = expense.amount || 0;
                const paidBy = expense.paidBy;
                const paidFor = expense.paidFor;
                const share = amount / (paidFor.length || 1);
                
                balances[paidBy] += amount - share;
                paidFor.forEach(user => {
                    if (user !== paidBy) {
                        balances[user] -= share;
                    }
                });
            });

            payments.forEach(payment => {
                const amount = payment.amount || 0;
                const from = payment.from;
                const to = payment.to;
                balances[from] -= amount;
                balances[to] += amount;
            });

            const balanceList = document.getElementById('balance-list');
            balanceList.innerHTML = '';
            for (const user in balances) {
                const balance = balances[user];
                if (balance !== 0) {
                    const li = document.createElement('li');
                    li.className = `font-semibold ${balance > 0 ? 'text-green-600' : 'text-red-600'}`;
                    li.textContent = `${user}: ${balance.toFixed(2)}€`;
                    balanceList.appendChild(li);
                }
            }
        }

        // Listener per i form
        function registerEventListeners() {
            document.getElementById('add-expense-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const description = document.getElementById('expense-description').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const paidBy = document.getElementById('expense-paid-by').value;
                const paidFor = Array.from(document.getElementById('expense-paid-for').selectedOptions).map(option => option.value);

                if (!paidFor.includes(paidBy)) {
                    paidFor.push(paidBy);
                }

                if (expensesCollection) {
                    try {
                        await addDoc(expensesCollection, {
                            description,
                            amount,
                            paidBy,
                            paidFor,
                            createdAt: new Date().toISOString(),
                        });
                        e.target.reset();
                        showToast('Spesa aggiunta con successo!');
                    } catch (error) {
                        console.error("Error adding expense:", error);
                        showToast('Errore nell\'aggiungere la spesa.', true);
                    }
                } else {
                    showToast('Errore: connessione al database non stabilita.', true);
                }
            });

            document.getElementById('record-payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const from = document.getElementById('payment-from').value;
                const to = document.getElementById('payment-to').value;
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const date = document.getElementById('payment-date').value;

                if (paymentsCollection) {
                    try {
                        await addDoc(paymentsCollection, {
                            from,
                            to,
                            amount,
                            date,
                            createdAt: new Date().toISOString(),
                        });
                        e.target.reset();
                        showToast('Pagamento registrato con successo!');
                    } catch (error) {
                        console.error("Error adding payment:", error);
                        showToast('Errore nel registrare il pagamento.', true);
                    }
                } else {
                    showToast('Errore: connessione al database non stabilita.', true);
                }
            });

            // Gestione dell'eliminazione delle spese
            document.getElementById('expenses-list').addEventListener('click', async (e) => {
                if (e.target.closest('.delete-expense')) {
                    const btn = e.target.closest('.delete-expense');
                    const expenseId = btn.getAttribute('data-id');
                    const modal = document.getElementById('delete-modal');
                    modal.style.display = 'flex';

                    const confirmBtn = document.getElementById('confirm-delete');
                    const cancelBtn = document.getElementById('cancel-delete');

                    confirmBtn.onclick = async () => {
                        modal.style.display = 'none';
                        try {
                            if (expensesCollection) {
                                const expenseDoc = doc(expensesCollection, expenseId);
                                await deleteDoc(expenseDoc);
                                showToast('Spesa eliminata con successo.');
                            } else {
                                showToast('Errore: connessione al database non stabilita.', true);
                            }
                        } catch (error) {
                            console.error("Error deleting expense:", error);
                            showToast('Errore nell\'eliminare la spesa.', true);
                        }
                    };

                    cancelBtn.onclick = () => {
                        modal.style.display = 'none';
                    };
                }
            });
        }

        // Avvia l'inizializzazione al caricamento della pagina
        window.onload = initFirebase;
    </script>
</body>

</html>








