<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Gestione Spese Condivise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-6 md:p-12">

    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 z-50 hidden">
        <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <div class="max-w-4xl mx-auto space-y-8">
        <div class="card text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestione Spese Condivise</h1>
            <p class="text-gray-500">Traccia e bilancia le spese con facilità.</p>
        </div>

        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Riepilogo Saldi</h2>
            <div class="flex flex-col md:flex-row gap-4 justify-around text-center font-semibold">
                <div class="p-4 rounded-lg bg-red-100 flex-1">
                    <p class="text-red-600 text-lg">Diego</p>
                    <p id="saldo-diego" class="text-red-800 text-2xl mt-1">- €0.00</p>
                </div>
                <div class="p-4 rounded-lg bg-green-100 flex-1">
                    <p class="text-green-600 text-lg">Lisa</p>
                    <p id="saldo-lisa" class="text-green-800 text-2xl mt-1">- €0.00</p>
                </div>
                <div class="p-4 rounded-lg bg-indigo-100 flex-1">
                    <p class="text-indigo-600 text-lg">Saldo Totale</p>
                    <p id="saldo-totale" class="text-indigo-800 text-2xl mt-1">- €0.00</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Aggiungi Nuova Spesa</h2>
            <form id="expense-form" class="space-y-4">
                <div>
                    <label for="expense-name" class="block text-gray-600 mb-1">Nome Spesa</label>
                    <input type="text" id="expense-name" required class="form-input">
                </div>
                <div>
                    <label for="expense-total" class="block text-gray-600 mb-1">Totale (€)</label>
                    <input type="number" step="0.01" id="expense-total" required class="form-input">
                </div>
                <div>
                    <label for="expense-notes" class="block text-gray-600 mb-1">Note (opzionali)</label>
                    <textarea id="expense-notes" rows="3" class="form-input"></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">Registra Spesa</button>
            </form>
        </div>

        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Registra Pagamento</h2>
            <form id="payment-form" class="space-y-4">
                <div>
                    <label for="payment-date" class="block text-gray-600 mb-1">Data</label>
                    <input type="date" id="payment-date" required class="form-input">
                </div>
                <div>
                    <label for="payment-expense" class="block text-gray-600 mb-1">Spesa di riferimento</label>
                    <select id="payment-expense" required class="form-input"></select>
                </div>
                <div>
                    <label for="payment-payer" class="block text-gray-600 mb-1">Chi ha pagato</label>
                    <select id="payment-payer" required class="form-input">
                        <option value="Diego">Diego</option>
                        <option value="Lisa">Lisa</option>
                    </select>
                </div>
                <div>
                    <label for="payment-amount" class="block text-gray-600 mb-1">Importo Pagato (€)</label>
                    <input type="number" step="0.01" id="payment-amount" required class="form-input">
                </div>
                <button type="submit" class="btn-primary w-full">Registra Pagamento</button>
            </form>
        </div>

        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Elenco Spese</h2>
            <div id="expenses-list" class="space-y-4">
                <p id="no-expenses" class="text-gray-500 text-center">Nessuna spesa registrata.</p>
            </div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Storico Pagamenti</h2>
            <div id="payments-history" class="space-y-4">
                <p id="no-payments" class="text-gray-500 text-center">Nessun pagamento registrato.</p>
            </div>
        </div>
        
        <div class="mt-4 text-center text-gray-500">
            <p>ID utente: <span id="user-id" class="font-mono text-xs"></span></p>
        </div>
        <div id="message-container" class="fixed bottom-6 right-6 z-50 w-80"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // Impostiamo il livello di log per il debug
        setLogLevel('debug');
        
        let db;
        let auth;
        let userId;
        let expensesCollection;
        let paymentsCollection;
        let expensesData = [];
        let paymentsData = [];
        
        // Elementi UI e funzioni di utilità
        const showLoading = () => document.getElementById('loading-spinner').classList.remove('hidden');
        const hideLoading = () => document.getElementById('loading-spinner').classList.add('hidden');
        const showMessage = (text, type = 'success') => {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 mb-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-transform transform translate-x-full`;
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            
            setTimeout(() => messageDiv.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                messageDiv.classList.add('translate-x-full');
                setTimeout(() => messageDiv.remove(), 500);
            }, 5000);
        };
        
        const expenseForm = document.getElementById('expense-form');
        const paymentForm = document.getElementById('payment-form');
        const expensesList = document.getElementById('expenses-list');
        const paymentsHistory = document.getElementById('payments-history');
        const paymentExpenseSelect = document.getElementById('payment-expense');
        const noExpensesMessage = document.getElementById('no-expenses');
        const noPaymentsMessage = document.getElementById('no-payments');
        const userIdEl = document.getElementById('user-id');
        
        // Funzione per calcolare e aggiornare i saldi
        const calculateBalances = () => {
            let totalSpentDiego = 0;
            let totalSpentLisa = 0;
            let totalDueDiego = 0;
            let totalDueLisa = 0;
            
            expensesData.forEach(expense => {
                const total = parseFloat(expense.totale);
                const half = total / 2;
                totalDueDiego += half;
                totalDueLisa += half;
            });

            paymentsData.forEach(payment => {
                if (payment.payer === 'Diego') {
                    totalSpentDiego += parseFloat(payment.amount);
                } else if (payment.payer === 'Lisa') {
                    totalSpentLisa += parseFloat(payment.amount);
                }
            });

            const saldoDiego = totalSpentDiego - totalDueDiego;
            const saldoLisa = totalSpentLisa - totalDueLisa;
            const saldoTotale = saldoDiego + saldoLisa;
            
            const saldoDiegoEl = document.getElementById('saldo-diego');
            const saldoLisaEl = document.getElementById('saldo-lisa');
            const saldoTotaleEl = document.getElementById('saldo-totale');

            saldoDiegoEl.textContent = `${saldoDiego >= 0 ? '+' : ''} €${saldoDiego.toFixed(2)}`;
            saldoDiegoEl.parentElement.classList.toggle('bg-red-100', saldoDiego < 0);
            saldoDiegoEl.parentElement.classList.toggle('bg-green-100', saldoDiego >= 0);
            saldoDiegoEl.classList.toggle('text-red-800', saldoDiego < 0);
            saldoDiegoEl.classList.toggle('text-green-800', saldoDiego >= 0);

            saldoLisaEl.textContent = `${saldoLisa >= 0 ? '+' : ''} €${saldoLisa.toFixed(2)}`;
            saldoLisaEl.parentElement.classList.toggle('bg-red-100', saldoLisa < 0);
            saldoLisaEl.parentElement.classList.toggle('bg-green-100', saldoLisa >= 0);
            saldoLisaEl.classList.toggle('text-red-800', saldoLisa < 0);
            saldoLisaEl.classList.toggle('text-green-800', saldoLisa >= 0);

            saldoTotaleEl.textContent = `${saldoTotale >= 0 ? '+' : ''} €${saldoTotale.toFixed(2)}`;
            saldoTotaleEl.parentElement.classList.toggle('bg-red-100', saldoTotale < 0);
            saldoTotaleEl.parentElement.classList.toggle('bg-green-100', saldoTotale >= 0);
            saldoTotaleEl.classList.toggle('text-red-800', saldoTotale < 0);
            saldoTotaleEl.classList.toggle('text-green-800', saldoTotale >= 0);
            saldoTotaleEl.parentElement.classList.toggle('bg-indigo-100', saldoTotale.toFixed(2) === "0.00");
            saldoTotaleEl.classList.toggle('text-indigo-800', saldoTotale.toFixed(2) === "0.00");
        };

        // Funzione per aggiornare la lista delle spese nel DOM
        const updateExpensesList = () => {
            expensesList.innerHTML = '';
            expensesData.sort((a, b) => b.createdAt - a.createdAt).forEach(expense => {
                // Calcola l'importo pagato per questa spesa specifica, basandosi sullo storico dei pagamenti
                const paidDiego = paymentsData
                    .filter(p => p.expenseId === expense.id && p.payer === 'Diego')
                    .reduce((sum, p) => sum + parseFloat(p.amount), 0);
                
                const paidLisa = paymentsData
                    .filter(p => p.expenseId === expense.id && p.payer === 'Lisa')
                    .reduce((sum, p) => sum + parseFloat(p.amount), 0);
                
                const remaining = expense.totale - (paidDiego + paidLisa);

                const expenseElement = document.createElement('div');
                expenseElement.className = 'p-6 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
                expenseElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-semibold text-gray-800">${expense.nome}</h3>
                        <span class="text-lg font-bold text-gray-700">€${expense.totale.toFixed(2)}</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">${expense.note || 'Nessuna nota'}</p>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
                        <p>Pagato da Diego: <span class="font-medium text-green-700">€${paidDiego.toFixed(2)}</span></p>
                        <p>Pagato da Lisa: <span class="font-medium text-green-700">€${paidLisa.toFixed(2)}</span></p>
                        <p>Residuo: <span class="font-bold ${remaining > 0 ? 'text-red-700' : 'text-green-700'}">€${remaining.toFixed(2)}</span></p>
                    </div>
                `;
                expensesList.appendChild(expenseElement);
            });
        };
        
        // Funzione per aggiornare la lista dei pagamenti nel DOM
        const updatePaymentsHistory = () => {
            paymentsHistory.innerHTML = '';
            paymentsData.sort((a, b) => b.createdAt - a.createdAt).forEach(payment => {
                const paymentElement = document.createElement('div');
                paymentElement.className = 'p-4 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
                const relatedExpense = expensesData.find(e => e.id === payment.expenseId);
                const expenseName = relatedExpense ? relatedExpense.nome : 'Spesa eliminata';
                const date = new Date(payment.createdAt).toLocaleDateString('it-IT');

                paymentElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <p class="text-gray-800 font-semibold">${payment.payer} ha pagato €${parseFloat(payment.amount).toFixed(2)}</p>
                        <span class="text-sm text-gray-500">${date}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">Spesa di riferimento: <span class="font-medium">${expenseName}</span></p>
                `;
                paymentsHistory.appendChild(paymentElement);
            });
        };

        // Funzione per aggiornare il menu a tendina dei pagamenti
        const updatePaymentSelect = () => {
            paymentExpenseSelect.innerHTML = '';
            expensesData.forEach(expense => {
                const option = document.createElement('option');
                option.value = expense.id;
                option.textContent = `${expense.nome} (€${expense.totale.toFixed(2)})`;
                paymentExpenseSelect.appendChild(option);
            });
        };

        const updateUI = () => {
            updateExpensesList();
            updatePaymentsHistory();
            updatePaymentSelect();
            calculateBalances();
            noExpensesMessage.classList.toggle('hidden', expensesData.length > 0);
            noPaymentsMessage.classList.toggle('hidden', paymentsData.length > 0);
        };
        
        // Funzione di inizializzazione che gestisce l'autenticazione e i listener
        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Errore di configurazione: La configurazione di Firebase è mancante.");
                    showMessage("Errore di configurazione. Controlla la console per i dettagli.", 'error');
                    return; 
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase Auth e Firestore inizializzati con successo.");
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = userId;
                        expensesCollection = collection(db, "artifacts", appId, "public", "data", "spese");
                        paymentsCollection = collection(db, "artifacts", appId, "public", "data", "pagamenti");
                        console.log("Autenticazione riuscita. ID utente:", userId);

                        onSnapshot(expensesCollection, (querySnapshot) => {
                            const tempExpensesData = [];
                            querySnapshot.forEach((doc) => {
                                tempExpensesData.push({ id: doc.id, ...doc.data() });
                            });
                            expensesData = tempExpensesData;
                            console.log("Dati spese aggiornati da Firestore.");
                            updateUI();
                        }, (error) => {
                            console.error("Errore nel listener dello snapshot spese: ", error);
                            showMessage("Errore di caricamento dei dati: " + error.message, 'error');
                        });

                        onSnapshot(paymentsCollection, (querySnapshot) => {
                            const tempPaymentsData = [];
                            querySnapshot.forEach((doc) => {
                                tempPaymentsData.push({ id: doc.id, ...doc.data() });
                            });
                            paymentsData = tempPaymentsData;
                            console.log("Dati pagamenti aggiornati da Firestore.");
                            updateUI();
                        }, (error) => {
                            console.error("Errore nel listener dello snapshot pagamenti: ", error);
                            showMessage("Errore di caricamento dei dati: " + error.message, 'error');
                        });
                        
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Errore durante l'autenticazione:", error);
                        }
                    }
                });

                // Gestori degli eventi
                expenseForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!expensesCollection) {
                        console.error("Collezione spese non disponibile.");
                        showMessage("App non ancora pronta. Riprova tra poco.", 'error');
                        return;
                    }
                    showLoading();
                    const name = document.getElementById('expense-name').value;
                    const total = parseFloat(document.getElementById('expense-total').value);
                    const notes = document.getElementById('expense-notes').value;
                    
                    const newExpense = {
                        nome: name,
                        totale: total,
                        note: notes,
                        createdAt: Date.now()
                    };
        
                    try {
                        await addDoc(expensesCollection, newExpense);
                        showMessage("Spesa registrata con successo!");
                        expenseForm.reset();
                    } catch (e) {
                        console.error("Errore nell'aggiungere il documento: ", e);
                        showMessage("Errore nella registrazione della spesa.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
        
                paymentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!expensesCollection || !paymentsCollection) {
                        console.error("Collezione pagamenti non disponibile.");
                        showMessage("App non ancora pronta. Riprova tra poco.", 'error');
                        return;
                    }
                    showLoading();
                    const expenseId = document.getElementById('payment-expense').value;
                    const date = document.getElementById('payment-date').value;
                    const payer = document.getElementById('payment-payer').value;
                    const amount = parseFloat(document.getElementById('payment-amount').value);
                    
                    if (!expenseId) {
                        showMessage("Seleziona una spesa.", 'error');
                        hideLoading();
                        return;
                    }
        
                    const newPayment = {
                        expenseId: expenseId,
                        date: date,
                        payer: payer,
                        amount: amount,
                        createdAt: Date.now()
                    };
                    
                    try {
                        await addDoc(paymentsCollection, newPayment);
                        showMessage("Pagamento registrato con successo!");
                        paymentForm.reset();
                    } catch (e) {
                        console.error("Errore nell'aggiungere il documento: ", e);
                        showMessage("Errore nella registrazione del pagamento.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            } catch (error) {
                console.error("Errore nell'inizializzazione di Firebase:", error);
            }
        }

        window.onload = initFirebase;
    </script>
</body>
</html>

